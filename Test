$username = "CHicago\Vrao"
$apiToken = "11ac371fd67a50e53ddc78ab1e3e6c2048"
$Miscclients = "TRN1"
$Miscapplications = @("UAT_Core_Tests")
$MiscenvSuccessCounts = @{}
$MiscenvTotalCounts = @{}
$MiscenvSuccessRates = @{}
$MiscbuildStatusResult = @()
$date = Get-Date -Format "MM/dd/yy"

foreach ($Miscapplication in $Miscapplications) {
    $MiscenvTotalCounts[$Miscapplication] = 0
}

foreach ($Miscclient in $Miscclients) {
    foreach ($Miscapplication in $Miscapplications) {
        $MiscenvTotalCounts[$Miscapplication]++
        $jenkinsUrll = "https://jenkins.evolenthealth.com/view/HPS%20Prod%20Ops/job/Environment%20Mgt/job/$Miscclient/job/$Miscclient" + "_$Miscapplication/lastBuild/api/json"
        $base64AuthInfoo = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes(("{0}:{1}" -f $username,$apiToken)))
        $MiscbuildStatus = Invoke-RestMethod -Uri $jenkinsUrll -Headers @{Authorization=("Basic {0}" -f $base64AuthInfoo)}
        $MiscshortAppName = $Miscapplication -replace '_.*'
        $Miscstatus = if ($MiscbuildStatus.result -eq "SUCCESS") {
            "Success"
            $MiscenvSuccessCounts[$Miscapplication]++
        }
        elseif ($MiscbuildStatus.result -eq "UNSTABLE") {
            "Unstable"
        }
        else {
            "Failed"
        }
        $MiscbuildStatusResult += [PSCustomObject]@{
            MiscClient = $Miscclient 
            MiscEnvironment = $MiscshortAppName
            MiscResult = $Miscstatus
        }
    }
}

foreach ($Miscapplication in $Miscapplications) {
    $MiscsuccessCount = $MiscenvSuccessCounts[$Miscapplication]
    $MisctotalCount = $MiscenvTotalCounts[$Miscapplication]
    $MiscsuccessRate = if ($MisctotalCount -eq 0) { 0 } else { [Math]::Round(($MiscsuccessCount / $MisctotalCount) * 100) }
    $MiscenvSuccessRates[$Miscapplication] = $MiscsuccessRate
}

$MiscsortedRates = $MiscenvSuccessRates.GetEnumerator() | Sort-Object Value

$MisctableRows = ""
foreach ($Miscenv in $MiscsortedRates) {
    $MiscsuccessRate = $Miscenv.Value
    $MiscenvName = $Miscenv.Name -replace '_.*', ''
    $MiscsuccessRateHtml = if ($MiscsuccessRate -ge 85) {
        "<td class='success'>$MiscsuccessRate%</td>"
    } elseif ($MiscsuccessRate -ge 50) {
        "<td class='unstable'>$MiscsuccessRate%</td>"
    } else {
        "<td class='failed'>$MiscsuccessRate%</td>"
    }
    if ($env -eq "UAT_Core_Tests"){
        $Miscenv = "UAT"
    }
    $MisctableRows += "<tr><td>$MiscenvName</td>$MiscsuccessRateHtml</tr>"
}

$html = @"
     <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        h1 {
            text-align: left; /* Align the title to the left */
            font-size: 24px; /* Set the font size to 24 */
            color: #2874A6; /* Set the title color to blue */
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff; /* Set the background color to white */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%; /* Set the table width to 100% */
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            vertical-align: middle;
        }

        th {
            background-color: #2874A6; /* Set the column names style to blue background */
            font-size: 16px; /* Set the font size to 16 */
            font-weight: bold;
            color: #ffffff; /* Set the column names style to white font color */
        }

        td {
            font-size: 14px;
            color: #333333; /* Set text color to dark gray */
            border: 1px solid #dddddd; /* Add borders to table cells */
        }

        .success {
            color: #4CAF50;
            font-weight: bold;
        }

        .failed {
            color: #f44336;
            font-weight: bold;
        }

        .unstable {
            color: #ff9800;
            font-weight: bold;
        }
 /* Add styles for success, failed, and unstable cells */
        .success {
            background-color: #DFF2DF; /* Set a light green background for success cells */
            color: #4CAF50;
            font-weight: bold;
        }

        .failed {
            background-color: #FADBD8; /* Set a light red background for failed cells */
            color: #f44336;
            font-weight: bold;
        }

        .unstable {
            background-color: #FEEFB3; /* Set a light yellow background for unstable cells */
            color: #ff9800;
            font-weight: bold;
        }
    </style>

<div class="container">
    <h1 style="color: #2874A6;">Environment Tests Overall Summary - $date</h1>
    <h3 style="color: #566573;">Miscellaneous Clients</h3>
    <table>
        <tr>
            <th class="header">Environment</th>
            <th class="header">Success Rate</th>
        </tr>
        $MisctableRows
    </table>
</div>
"@

$html | Set-Content -Path "email_body.html"
